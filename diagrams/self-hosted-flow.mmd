flowchart LR
  subgraph Submit[1. Message submission]
    A["Internal Client / System<br/>(HTTPS POST /messages)"]
  end
  A --> B["2. Persist message & schedule<br/>Store message + per-device dispatch"]
  B --> C["3. Encrypt (optional) & package<br/>Encrypted payload (opaque)"]
  C --> D["4. Pass-through Relay<br/>(Receives encrypted payload)"]
  D --> E["5. External Push Networks<br/>APNs / FCM / Web Push"]
  E --> F["6. Devices receive & ACK"]
  F --> G{"All ACKs or TTL 7d"}
  G -->|Yes| H["Prune message & attachments"]
  G -->|No| E
